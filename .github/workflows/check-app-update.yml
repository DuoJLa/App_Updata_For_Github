name: Check App Store Updates

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ✅ 修复：删除 cache 配置
      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: 检查应用更新
        env:
          PUSH_METHOD: ${{ secrets.PUSH_METHOD }}
          BARK_KEY: ${{ secrets.BARK_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          APP_IDS: ${{ secrets.APP_IDS }}
        run: |
          echo "开始检查应用更新..."
          python check_update.py
          echo "检查完成"
      
      - name: 检查文件变化
        id: check_changes
        run: |
          if [ -f "version_cache.json" ]; then
            git add version_cache.json
            if git diff --staged --quiet; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "缓存无变化"
            else
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "缓存已更新"
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 提交缓存
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "chore: update version cache [skip ci]"
          git push
      
      - name: 无变化日志
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "✅ 本次运行无需提交缓存"
